# GitHub Star 项目分类与摘要脚本需求

## 目标
- 编写 Python 脚本，对 GitHub 已加星项目进行分类、打标签并生成摘要，输出到 CSV。

## 功能概述
- 获取 GitHub Star 项目信息。
- 使用 ZHIPU AI（OpenAI API 风格）分析，生成分类、标签、摘要。
- 将分析结果写入 CSV 文件。
- 项目数量巨大（> 4000），支持分批执行：每次处理 10 个项目，最终合并结果。
- 执行顺序按添加星标时间升序排序（`starred_at` 早→晚）。

## 固定分类（category）
- 为保持一致性，分类仅允许以下固定集合之一：
  - `Web应用`、`移动应用`、`桌面应用`、`数据库`、`AI/机器学习`、`开发工具`、`安全工具`、`游戏`、`设计工具`、`效率工具`、`教育学习`、`社交网络`、`数据分析`
- AI 返回的分类若不在列表中，脚本将基于关键词与主题进行就近映射；找不到时回退为 `开发工具`。

## 分类配置（可配置）
- 为避免硬编码，分类与关键词映射支持通过环境变量或外部文件配置：
  - `CATEGORIES`：逗号分隔的分类列表（例如：`Web应用,移动应用,桌面应用,...`）。
  - `CATEGORIES_FILE`：JSON 数组文件路径，内容为分类列表。
  - `CATEGORY_RULES_FILE`：JSON 对象文件路径，键为分类、值为关键词数组，用于本地关键词匹配与分类映射。
  - `DEFAULT_CATEGORY`：无法匹配时的默认分类（默认：`开发工具`）。
- CLI 参数（覆盖环境变量）：
  - `--categories-file`、`--category-rules-file`、`--default-category`。
- 示例：
  - `categories.json`（数组）：
    ```json
    ["Web应用", "移动应用", "桌面应用", "数据库", "AI/机器学习", "开发工具", "安全工具", "游戏", "设计工具", "效率工具", "教育学习", "社交网络", "数据分析"]
    ```
  - `category_rules.json`（对象）：
    ```json
    {
      "Web应用": ["web", "http", "rest", "vue", "react", "svelte"],
      "移动应用": ["android", "ios", "mobile", "flutter"],
      "桌面应用": ["desktop", "electron", "qt"],
      "数据库": ["database", "sql", "nosql", "postgres", "mysql"],
      "AI/机器学习": ["ml", "ai", "deep learning", "llm", "pytorch"],
      "开发工具": ["sdk", "framework", "cli", "build", "testing"],
      "安全工具": ["security", "pentest", "encryption"],
      "游戏": ["game", "unity", "godot"],
      "设计工具": ["design", "ui", "ux"],
      "效率工具": ["todo", "note", "automation"],
      "教育学习": ["tutorial", "course", "docs"],
      "社交网络": ["social", "chat", "community"],
      "数据分析": ["analytics", "pandas", "visualization"]
    }
    ```
  - 使用方式：设置 `.env` 中的 `CATEGORIES_FILE` 或 `CATEGORY_RULES_FILE`，或在运行时传入 CLI 参数。

## 输入与输出
- 输入：
  - GitHub 已加星项目列表，包含 `repo_full_name`、`html_url`、`description`、`topics`、`starred_at` 等。
- 输出（CSV 字段建议）：
  - `repo_full_name`、`owner`、`html_url`、`description`、`topics`、`category`、`tags`、`summary`、`starred_at`、`analyzed_at`。

## 执行流程
- 按 `starred_at` 升序拉取已加星项目。
- 以 10 个为一批遍历项目，对每个项目调用 ZHIPU AI 完成分析。
- 将每批分析结果追加写入 CSV；支持断点续跑。
- 所有批次完成后，合并 CSV 并去重，保持升序。

## 批处理与合并规范
- 每次执行直接写入并合并到 `outputs/results_all.json`、`outputs/results_all.csv`、`outputs/results_all.md`。
- 不再生成 `results_part_*` 文件（兼容性：若存在旧的 part 文件，首次无合并文件时会自动汇总一次）。
- 去重规则：以 `repo_full_name` + `starred_at` 作为唯一键。
- 合并时统一列顺序与编码（`utf-8`）。

## 依赖与配置
- 环境：Python 3.10+。
- 令牌：
  - `GITHUB_TOKEN` 用于访问加星列表 API。
  - `ZHIPU_API_KEY` 用于调用 ZHIPU AI。
 - 依赖：`requests`（GitHub API）、`openai`（ZHIPU OpenAI 客户端），内置 `csv`。可选：`pandas`、`tenacity`。

## 注意事项
- 考虑 GitHub API 速率限制与分页；实现重试与合理的 `sleep`。
- 对空描述或无主题的仓库，给予稳健的提示与分析降级。
- 控制调用成本，必要时进行 prompt 压缩或启用批量模式。
- 避免写入敏感信息；摘要尽量简洁、可读。

## 使用 uv 管理环境与依赖（推荐）
- 安装（Windows PowerShell）：
  - `iwr -useb https://astral.sh/uv/install.ps1 | iex`
- 初始化项目并创建 `pyproject.toml`：
  - 在项目根目录执行：`uv init`
- 创建虚拟环境（可选，`uv sync` 会自动创建）：
  - `uv venv .venv`
- 添加依赖：
  - 基础依赖：`uv add requests openai`
  - 可选：`uv add pandas tenacity`
  - 如需开发工具：`uv add --dev ruff black`
- 同步安装（根据 `pyproject.toml` 和锁文件）：
  - `uv sync`
- 运行脚本（无需手动激活虚拟环境）：
  - `uv run python your_script.py --batch-size 10`
- 环境变量（PowerShell 临时设置）：
  - `$env:GITHUB_TOKEN="<你的token>"`
  - `$env:ZHIPU_API_KEY="<你的key>"`
  - `$env:ZHIPU_BASE_URL="https://open.bigmodel.cn/api/paas/v4/"`
  - `$env:ZHIPU_MODEL="glm-4.5-flash"`
  - `$env:CATEGORIES_FILE="c:/path/to/categories.json"`
  - `$env:CATEGORY_RULES_FILE="c:/path/to/category_rules.json"`
  - `$env:DEFAULT_CATEGORY="开发工具"`

### 基础地址解析优先级（BASE_URL）
- 运行时按以下优先级解析 `BASE_URL`：
  1. CLI 参数 `--base-url`
  2. 环境变量或 `.env` 中的 `ZHIPU_BASE_URL`
  3. 代码内默认值 `https://open.bigmodel.cn/api/paas/v4/`
- 示例运行：
  - `python stars_manager.py --base-url https://open.bigmodel.cn/api/paas/v4/ --batch-size 10`

> 说明：使用 `uv add` 管理依赖将它们写入 `pyproject.toml`；`uv run` 会在隔离环境中执行命令并确保依赖可用。

## 环境变量与 .env（零依赖加载）
- 在项目根创建 `.env` 文件（已在 `.gitignore` 忽略）：
  - 示例内容：
    - `GITHUB_TOKEN=ghp_xxx`
    - `ZHIPU_API_KEY=xxx`
- 在 Python 中零依赖加载 `.env`：
  - 将以下函数放在入口脚本，并在使用环境变量前调用：
  - 
    ```python
    import os

    def load_env(path=".env"):
        if not os.path.exists(path):
            return
        with open(path, "r", encoding="utf-8") as f:
            for line in f:
                line = line.strip()
                if not line or line.startswith("#") or "=" not in line:
                    continue
                key, value = line.split("=", 1)
                os.environ.setdefault(key.strip(), value.strip())
    ```
- 使用方式：
  - 在脚本开头执行 `load_env()`，随后通过 `os.environ["GITHUB_TOKEN"]`、`os.environ["ZHIPU_API_KEY"]` 获取值。
- 安全提示：
  - 不要提交 `.env` 到代码仓库；为不同环境维护不同 `.env` 文件。